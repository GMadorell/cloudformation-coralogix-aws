AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Send Kinesis Firehose stream data to Coralogix.

Parameters:
  CoralogixRegion:
    Type: String
    Description: The Coralogix location region [Europe, Europe2, India, Singapore, US]
    AllowedValues:
      - Europe
      - Europe2
      - India
      - Singapore
      - US
    Default: Europe
  CoralogixApiKey:
    Type: String
    Description: The Coralogix Api key which is used to validate your authenticity.
    NoEcho: true
  ApplicationName:
    Type: String
    Description: The desired Application Name within the Coralogix Platform. If not set, it will be the delivery stream name.
    Default: ""
  SubsystemName:
    Type: String
    Description: The desired Subsystem Name within the Coralogix Platform. If not set, it will be the ARN.
    Default: ""
  CloudwatchRetentionDays:
    Type: Number
    Description: Days of retention in Cloudwatch Log Groups.
    Default: 1
  DynamicMetadata:
    Type: String
    Description: When set to true, it fetches set the applicationName / subsystemName dynamically
    AllowedValues:
      - ""
      - 'true'
      - 'false'
    Default: ""
  EnableLogsStream:
    Type: String
    Description: Enable logs streaming to Coralogix
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
  IntegrationTypeLogs:
    Type: String
    Description: The data structure of the Firehose delivery stream for logs [CloudWatch_JSON, WAF, CloudWatch_CloudTrail, EksFargate, Default, RawText]
    AllowedValues:
      - ""
      - CloudWatch_JSON
      - WAF
      - CloudWatch_CloudTrail
      - EksFargate
      - Default
      - RawText
    Default: ""
  KinesisStreamARN:
    Type: String
    Description: Optional - If using Kinesis Stream as source, enter the ARN of the Kinesis stream, else leave blank.
    Default: ""
  EnableMetricsStream:
    Type: String
    Description: Enable metrics streaming to Coralogix
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
  IntegrationTypeMetrics:
    Type: String
    Description: "The integration type of the firehose delivery stream [CloudWatch_Metrics_OpenTelemetry070, CloudWatch_Metrics_JSON] - default: CloudWatch_Metrics_OpenTelemetry070"
    AllowedValues:
      - CloudWatch_Metrics_OpenTelemetry070
      - CloudWatch_Metrics_JSON
    Default: CloudWatch_Metrics_OpenTelemetry070
  OutputFormat:
    Type: String
    Description: "The output format of the cloudwatch metric stream [opentelemetry0.7, json] - default: opentelemetry0.7"
    AllowedValues:
      - opentelemetry0.7
      - json
    Default: opentelemetry0.7
  Namespaces:
    Description: >-
      A comma-delimited list of namespaces to include or exclude from the metric stream.
    Type: String
    Default: 'AWS/EC2,AWS/EKS,AWS/ELB,AWS/Logs,AWS/S3'

Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - Label: 
          default: "Required"
        Parameters: 
          - CoralogixRegion
          - CoralogixApiKey
      - Label: 
          default: "Others"
        Parameters: 
          - ApplicationName
          - SubsystemName
          - CloudwatchRetentionDays
          - DynamicMetadata
      - Label: 
          default: "Logs Streaming"
        Parameters: 
          - EnableLogsStream
          - IntegrationTypeLogs
          - KinesisStreamARN
      - Label:
          default: "Metrics Streaming"
        Parameters:
          - EnableMetricsStream
          - IntegrationTypeMetrics
          - OutputFormat
Mappings:
  CoralogixRegionMap:
    Europe:
      LogUrl: https://firehose-ingress.coralogix.com/firehose
    Europe2:
      LogUrl: https://firehose-ingress.eu2.coralogix.com/firehose
    India:
      LogUrl: https://firehose-ingress.coralogix.in/firehose
    Singapore:
      LogUrl: https://firehose-ingress.coralogixsg.com/firehose
    US:
      LogUrl: https://firehose-ingress.coralogix.us/firehose

Conditions:
  IsApplicationName: !Not [!Equals [!Ref ApplicationName, ""]]
  IsSubsystemName: !Not [!Equals [!Ref SubsystemName, ""]]
  IsIntegrationTypeLogs: !Not [!Equals [!Ref IntegrationTypeLogs, ""]]
  IsDynamicMetadata: !Not [!Equals [ !Ref DynamicMetadata, ""]]
  IsKinesisStreamAsSource: !Not [!Equals [ !Ref KinesisStreamARN, "" ]]
  IsLogsEnabled: !Not [!Equals [ !Ref EnableLogsStream, "false" ]]
  IsMetricsEnabled: !Not [!Equals [ !Ref EnableMetricsStream, "false" ]]

Resources:
  BackupDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-backup'
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  DeliveryStreamLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/kinesisfirehose/${AWS::StackName}'
      RetentionInDays: !Ref CloudwatchRetentionDays
  DeliveryStreamLogStream:
    Type: AWS::Logs::LogStream
    Properties:
      LogGroupName: !Ref DeliveryStreamLogGroup
      LogStreamName: !Ref AWS::StackName

###################################
# Firehose Logs Stream
###################################
  CloudWatchLogsRole:
    Condition: IsLogsEnabled
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
          Action: sts:AssumeRole
  CloudWatchLogsPolicy:
    Condition: IsLogsEnabled
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub '${AWS::StackName}-logs-policy'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - firehose:PutRecord
          - firehose:PutRecordBatch
          - kinesis:PutRecord
          - kinesis:PutRecordBatch
          Resource:
          - !Sub 'arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:*'
        - Effect: Allow
          Action:
          - iam:PassRole
          Resource:
          - !Sub 'arn:aws:iam::${AWS::AccountId}:role/${CloudWatchLogsRole}'
      Roles:
      - Ref: CloudWatchLogsRole
  FirehoseLogsRole:
    Condition: IsLogsEnabled
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Service: 'firehose.amazonaws.com'
          Action: sts:AssumeRole
          Condition:
            StringEquals:
              sts:ExternalId:
                Ref: AWS::AccountId
  FirehoseLogsPolicy:
    Condition: IsLogsEnabled
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub '${AWS::StackName}-firehose-policy'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - s3:AbortMultipartUpload
          - s3:GetBucketLocation
          - s3:GetObject
          - s3:ListBucket
          - s3:ListBucketMultipartUploads
          - s3:PutObject
          Resource:
          - !Sub 'arn:aws:s3:::${BackupDataBucket}'
          - !Sub 'arn:aws:s3:::${BackupDataBucket}/*'
        - Effect: Allow
          Action:
          - logs:PutLogEvents
          Resource: !GetAtt DeliveryStreamLogGroup.Arn
        - Effect: Allow
          Action:
            - kinesis:DescribeStream
            - kinesis:GetShardIterator
            - kinesis:GetRecords
            - kinesis:ListShards
          Resource: 
          - !Sub 'arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/*'
          - !Sub 'arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/*'
      Roles:
      - Ref: FirehoseLogsRole
  CoralogixDeliveryLogsStream:
    Condition: IsLogsEnabled
    DependsOn:
    - FirehoseLogsPolicy
    - CloudWatchLogsPolicy
    - BackupDataBucket
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamName: !Sub '${AWS::StackName}-logs'
      DeliveryStreamType:
        !If
          - IsKinesisStreamAsSource
          - KinesisStreamAsSource
          - DirectPut
      KinesisStreamSourceConfiguration:
        !If
          - IsKinesisStreamAsSource
          - KinesisStreamARN: !Ref KinesisStreamARN
            RoleARN: !GetAtt FirehoseLogsRole.Arn
          - !Ref 'AWS::NoValue'
      HttpEndpointDestinationConfiguration:
        RoleARN:
          !GetAtt FirehoseLogsRole.Arn
        EndpointConfiguration:
          Url: 
            Fn::FindInMap: [ CoralogixRegionMap, !Ref CoralogixRegion, LogUrl ]
          AccessKey:
            Ref: CoralogixApiKey
          Name: 
            'Coralogix'
        RequestConfiguration:
          ContentEncoding: GZIP
          CommonAttributes:
            - !If 
              - IsApplicationName
              - AttributeName: 'applicationName'
                AttributeValue: !Ref ApplicationName
              - !Ref 'AWS::NoValue'
            - !If
              - IsSubsystemName
              - AttributeName: 'subsystemName'
                AttributeValue: !Ref SubsystemName
              - !Ref 'AWS::NoValue'
            - !If
              - IsIntegrationTypeLogs
              - AttributeName: 'integrationType'
                AttributeValue: !Ref IntegrationTypeLogs
              - !Ref 'AWS::NoValue'
            - !If
              - IsDynamicMetadata
              - AttributeName: 'dynamicMetadata'
                AttributeValue: !Ref DynamicMetadata
              - !Ref 'AWS::NoValue'
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName:
            Ref: DeliveryStreamLogGroup
          LogStreamName:
            Ref: DeliveryStreamLogStream
        BufferingHints:
          IntervalInSeconds: 60
          SizeInMBs: 6
        RetryOptions:
          DurationInSeconds: 300
        S3BackupMode: FailedDataOnly
        S3Configuration:
          BufferingHints:
            IntervalInSeconds: 300
            SizeInMBs: 5
          BucketARN: !GetAtt BackupDataBucket.Arn
          CompressionFormat: GZIP
          RoleARN:
            !GetAtt FirehoseLogsRole.Arn

###################################
# Firehose Metrics Stream
###################################
  LambdaProcessorRole:
    Condition: IsMetricsEnabled
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-lambda'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Service: !Sub 'lambda.amazonaws.com'
          Action: sts:AssumeRole
  LambdaProcessorPolicy:
    Condition: IsMetricsEnabled
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub '${AWS::StackName}-lambda'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - tag:GetResources
          - cloudwatch:GetMetricData
          - cloudwatch:GetMetricStatistics
          - cloudwatch:ListMetrics
          - apigateway:GET
          - aps:ListWorkspaces
          - autoscaling:DescribeAutoScalingGroups
          - dms:DescribeReplicationInstances
          - dms:DescribeReplicationTasks
          - ec2:DescribeTransitGatewayAttachments
          - ec2:DescribeSpotFleetRequests
          - storagegateway:ListGateways
          - storagegateway:ListTagsForResource
          Resource:
          - '*'
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource:
          - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*:*'
      Roles:
      - Ref: LambdaProcessorRole
  LambdaMetricsTagsProcessors:
    Condition: IsMetricsEnabled
    Type: 'AWS::Lambda::Function'
    Properties:
      Code:
        S3Bucket: !Sub 'cx-cw-metrics-tags-lambda-processor-${AWS::Region}'
        S3Key: function.zip
      FunctionName: !Sub '${AWS::StackName}-metrics-transform'
      Handler: function
      Runtime: go1.x
      Role: !GetAtt LambdaProcessorRole.Arn
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          FILE_CACHE_PATH: "/tmp"
  FirehoseMetricsRole:
    Condition: IsMetricsEnabled
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-firehose'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Service: 'firehose.amazonaws.com'
          Action: sts:AssumeRole
          Condition:
            StringEquals:
              sts:ExternalId:
                Ref: AWS::AccountId
  FirehoseMetricsPolicy:
    Condition: IsMetricsEnabled
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub '${AWS::StackName}-firehose'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - s3:AbortMultipartUpload
          - s3:GetBucketLocation
          - s3:GetObject
          - s3:ListBucket
          - s3:ListBucketMultipartUploads
          - s3:PutObject
          Resource:
          - !Sub 'arn:aws:s3:::${BackupDataBucket}'
          - !Sub 'arn:aws:s3:::${BackupDataBucket}/*'
        - Effect: Allow
          Action:
          - logs:PutLogEvents
          Resource: !GetAtt DeliveryStreamLogGroup.Arn
        - Effect: Allow
          Action:
            - kinesis:DescribeStream
            - kinesis:GetShardIterator
            - kinesis:GetRecords
            - kinesis:ListShards
          Resource: 
          - !Sub 'arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/*'
          - !Sub 'arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/*'
        - Effect: Allow
          Action:
          - kms:Decrypt
          - kms:GenerateDataKey
          Resource:
          - !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'
          Condition:
            StringEquals:
              kms:ViaService: !Sub 's3.${AWS::Region}.amazonaws.com'
            StringLike:
              kms:EncryptionContext: !Sub 'arn:aws:s3:::${BackupDataBucket}'
        - Effect: Allow
          Action:
          - lambda:InvokeFunction
          - lambda:GetFunctionConfiguration
          Resource:
          - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*'
      Roles:
      - Ref: FirehoseMetricsRole
  CoralogixDeliveryMetricsStream:
    Condition: IsMetricsEnabled
    Type: AWS::KinesisFirehose::DeliveryStream
    DependsOn:
    - FirehoseMetricsPolicy
    - CloudWatchMetricsPolicy
    - BackupDataBucket
    - LambdaMetricsTagsProcessors
    Properties:
      DeliveryStreamName: !Sub '${AWS::StackName}-metrics'
      DeliveryStreamType: DirectPut
      HttpEndpointDestinationConfiguration:
        RoleARN:
          !GetAtt FirehoseMetricsRole.Arn
        EndpointConfiguration:
          Url: 
            Fn::FindInMap: [ CoralogixRegionMap, !Ref CoralogixRegion, LogUrl ]
          AccessKey:
            Ref: CoralogixApiKey
          Name: 
            'Coralogix'
        RequestConfiguration:
          ContentEncoding: GZIP
          CommonAttributes:
            - AttributeName: 'integrationType'
              AttributeValue: !Ref IntegrationTypeMetrics
            - !If 
              - IsApplicationName
              - AttributeName: 'applicationName'
                AttributeValue: !Ref ApplicationName
              - !Ref 'AWS::NoValue'
            - !If
              - IsSubsystemName
              - AttributeName: 'subsystemName'
                AttributeValue: !Ref SubsystemName
              - !Ref 'AWS::NoValue'
            - !If
              - IsDynamicMetadata
              - AttributeName: 'dynamicMetadata'
                AttributeValue: !Ref DynamicMetadata
              - !Ref 'AWS::NoValue'
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName:
            Ref: DeliveryStreamLogGroup
          LogStreamName:
            Ref: DeliveryStreamLogStream
        BufferingHints:
          IntervalInSeconds: 60
          SizeInMBs: 1
        RetryOptions:
          DurationInSeconds: 30
        S3BackupMode: FailedDataOnly
        S3Configuration:
          BufferingHints:
            IntervalInSeconds: 300
            SizeInMBs: 5
          BucketARN: 
            !GetAtt BackupDataBucket.Arn
          CompressionFormat: GZIP
          RoleARN:
            !GetAtt FirehoseMetricsRole.Arn
        ProcessingConfiguration:
          Enabled: true
          Processors:
          - Type: Lambda
            Parameters:
              - ParameterName: LambdaArn
                ParameterValue: !Sub '${LambdaMetricsTagsProcessors.Arn}:$LATEST'
              - ParameterName: BufferSizeInMBs
                ParameterValue: '0.2'
              - ParameterName: BufferIntervalInSeconds
                ParameterValue: '61'
  CloudWatchMetricsRole:
    Condition: IsMetricsEnabled
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-cw'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Service: !Sub 'streams.metrics.cloudwatch.amazonaws.com'
          Action: sts:AssumeRole
  CloudWatchMetricsPolicy:
    Condition: IsMetricsEnabled
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub '${AWS::StackName}-cw'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - firehose:PutRecord
          - firehose:PutRecordBatch
          - firehose:DeleteDeliveryStream
          - firehose:UpdateDestination
          Resource: !Sub 'arn:aws:firehose:${AWS::Region}:${AWS::AccountId}:deliverystream/*'
      Roles:
      - Ref: CloudWatchMetricsRole

  LambdaCustomResourceCloudWatchMetricStreamRole:
    Condition: IsMetricsEnabled
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: inline-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricStream
                  - cloudwatch:DeleteMetricStream
                Resource: !Sub "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:metric-stream/*"
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !Sub "arn:aws:iam::${AWS::AccountId}:role/${CloudWatchMetricsRole}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  LambdaCustomResourceCloudWatchMetricStreamFunction:
    Condition: IsMetricsEnabled
    Type: AWS::Lambda::Function
    Properties:
      Description: "The lambda function is used to create CloudWatch Metric Stream."
      Handler: index.handler
      Code:
        ZipFile: |
          import sys
          import subprocess

          subprocess.check_call([sys.executable, "-m", "pip", "install", '--upgrade', 'boto3', '--target', '/tmp/'])
          sys.path.insert(0, '/tmp/')

          import boto3
          import cfnresponse


          def handler(event, context):
              response_data = {}
              physical_id = ""
              namespaces_list = []
              try:
                  client = boto3.client('cloudwatch')
                  properties = event['ResourceProperties']
                  physical_id = properties['Name']
                  print("Received %s Event Type." % event['RequestType'])
                  if event['RequestType'] == "Delete":
                      response_data = client.delete_metric_stream(Name=physical_id)
                  else:
                      namespaces = properties["Namespaces"]
                      if namespaces:
                          namespaces = namespaces.split(",")
                          for namespace in namespaces:
                              namespaces_list.append({'Namespace': namespace.strip()})
                      response_data = client.put_metric_stream(Name=physical_id, FirehoseArn=properties['FirehoseArn'],
                                                               RoleArn=properties['RoleArn'],
                                                               OutputFormat=properties['OutputFormat'],
                                                               IncludeFilters=namespaces_list)
              except Exception as e:
                  print(e)
                  cfnresponse.send(event, context, cfnresponse.FAILED, {"Error": str(e)}, physical_id)
              cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data, physical_id)
      Runtime: python3.7
      Timeout: 300
      Role: !GetAtt LambdaCustomResourceCloudWatchMetricStreamRole.Arn

  LambdaCustomResourceCloudWatchMetricsStream:
    Condition: IsMetricsEnabled
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt LambdaCustomResourceCloudWatchMetricStreamFunction.Arn
      Name: !Ref AWS::StackName
      OutputFormat: !Ref OutputFormat
      FirehoseArn: !GetAtt CoralogixDeliveryMetricsStream.Arn
      RoleArn: !GetAtt CloudWatchMetricsRole.Arn
      Namespaces: !Ref Namespaces

Outputs:
  BackupDataBucketName:
    Description: S3 Bucket where failed deliveries will be backed-up
    Value: !Sub '${AWS::StackName}-backup'
  CoralogixDeliveryLogsStreamARN:
    Condition: IsLogsEnabled
    Description: The ARN for your Kinesis Firehose Delivery Stream, use this as the
      destination when adding CloudWatch Logs subscription filters
    Value:
      !GetAtt CoralogixDeliveryLogsStream.Arn
  CloudWatchLogsRoleARN:
    Condition: IsLogsEnabled
    Description: The ARN for your CloudWatch Logs role to write to your delivery stream,
      use this as the role-arn when adding CloudWatch Logs subscription filters
    Value:
      !GetAtt CloudWatchLogsRole.Arn
  CoralogixDeliveryMetricsStreamARN:
    Condition: IsMetricsEnabled
    Description: The ARN for your Kinesis Firehose Delivery Stream, use this as the
      destination when adding CloudWatch Metrics subscription filters
    Value:
      !GetAtt CoralogixDeliveryMetricsStream.Arn